From 838025a28e267c4ffcbb44810974e20c6774ca1f Mon Sep 17 00:00:00 2001
From: Marco von Raumer <marco.von.raumer@digitecgalaxus.ch>
Date: Tue, 26 Aug 2025 00:25:13 +0200
Subject: [PATCH] Patch for fido

---
 INSTALL.md                           | 66 ++++++++++++++++++++++++++++
 README.md                            |  4 ++
 app/auth/authenticateWithChromium.js | 33 ++++++++++++++
 app/auth/importIntoElectron.js       | 39 ++++++++++++++++
 app/auth/launchChromium.js           | 66 ++++++++++++++++++++++++++++
 app/auth/pullFromChromium.js         | 30 +++++++++++++
 app/mainAppWindow/index.js           | 32 ++++++++++++++
 create_patch.sh                      |  2 +
 launch_testing.sh                    |  8 ++++
 package-lock.json                    | 62 ++++++++++++++++++++++++--
 package.json                         |  3 ++
 11 files changed, 341 insertions(+), 4 deletions(-)
 create mode 100644 INSTALL.md
 create mode 100644 app/auth/authenticateWithChromium.js
 create mode 100644 app/auth/importIntoElectron.js
 create mode 100644 app/auth/launchChromium.js
 create mode 100644 app/auth/pullFromChromium.js
 create mode 100755 create_patch.sh
 create mode 100755 launch_testing.sh

diff --git a/INSTALL.md b/INSTALL.md
new file mode 100644
index 0000000..f9f079b
--- /dev/null
+++ b/INSTALL.md
@@ -0,0 +1,66 @@
+# How to use this fork
+
+## Prerequisites
+
+You need a **chromium based browser** installed. If you have either `chromium`, `chrome` or `brave` in your PATH, it will work.
+[See here](https://github.com/marcovr/teams-for-linux/blob/main/app/auth/launchChromium.js#L33).
+
+Otherwise, you can set the environment variable `T4L_CHROMIUM_BINARY` to a suitbale binary name / file path.
+
+## Testing
+
+```sh
+npm install
+npm run start
+```
+
+## Installation
+
+### NixOS
+
+First, create a patch file
+
+```sh
+./create_patch.sh
+```
+
+Then, modify the [teams-for-linux package](https://github.com/NixOS/nixpkgs/blob/nixos-25.05/pkgs/by-name/te/teams-for-linux/package.nix)
+to include the patch and update the npmDepsHash. For example:
+
+```nix
+  # ...
+  patches = [ /development/teams-for-linux/0001-Patch-for-fido.patch ];
+  npmDepsHash = "sha256-DspCw2MmuH3tWPl9ErK8MsHM4tW5I4GCWN9Fv4pZ2Hg=";
+  # ...
+```
+
+### Generic Linux
+
+
+```sh
+npm install
+npm run pack
+```
+
+The packaged teams-for-linux waits for you in the `./dist/` folder.
+Just link the binary to a folder in your path env. For example:
+
+```sh
+ln -s "$(pwd)/dist/linux-unpacked/teams-for-linux" "/usr/bin/teams-for-linux"
+```
+
+If needed, add a desktop file, like `~/.local/share/applications/teams-for-linux.desktop`:
+
+```ini
+[Desktop Entry]
+Version=1.0
+Type=Application
+Name=Teams for Linux
+Icon=/opt/teams-for-linux/build/icons/256x256.png
+Exec="/usr/bin/teams-for-linux"
+Comment=An electron port for Microsoft Teams
+Categories=Chat;
+Terminal=false
+StartupWMClass=teams-for-linux
+StartupNotify=true
+```
diff --git a/README.md b/README.md
index b2fd674..3de84f1 100644
--- a/README.md
+++ b/README.md
@@ -32,6 +32,10 @@ questions. That's probably the quickest way to find solutions.
 [![Known Vulnerabilities](https://snyk.io//test/github/IsmaelMartinez/teams-for-linux/badge.svg?targetFile=package.json)](https://snyk.io//test/github/IsmaelMartinez/teams-for-linux?targetFile=package.json)
 [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=IsmaelMartinez_teams-for-linux&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=IsmaelMartinez_teams-for-linux)
 
+> [!NOTE]  
+> This is a fork of [Teams for Linux](https://github.com/IsmaelMartinez/teams-for-linux/)
+with patch to work around the limitations of electron apps related to FIDO authentication: https://github.com/electron/electron/issues/24573
+
 Unofficial Microsoft Teams client for Linux using
 [`Electron`](https://electronjs.org/). It uses the Web App and wraps it as a
 standalone application using Electron.
diff --git a/app/auth/authenticateWithChromium.js b/app/auth/authenticateWithChromium.js
new file mode 100644
index 0000000..6c931cd
--- /dev/null
+++ b/app/auth/authenticateWithChromium.js
@@ -0,0 +1,33 @@
+const launchChromium = require("./launchChromium");
+const fetchCookies = require("./pullFromChromium");
+const importCookiesIntoElectron = require("./importIntoElectron");
+
+exports = module.exports = async function doIt(partition) {
+  console.log(`Launching Chromium for login flow`);
+  const chrome = await launchChromium();
+  const cookies = await waitForCookies(chrome);
+  chrome.proc.kill("SIGTERM");
+
+  console.log(`Importing cookies into partition '${partition}'`);
+  await importCookiesIntoElectron(cookies, partition);
+}
+
+async function waitForCookies(chrome) {
+  let cookies = [];
+
+  while (!isLoggedIn(cookies)) {
+    console.log("Waiting for cookies...");
+    await sleep(3_000);
+    cookies = await fetchCookies(chrome.port);
+  }
+
+  return cookies;
+}
+
+function isLoggedIn(cookies) {
+  return cookies.find(c => c.name.startsWith("ESTS")) // e.g. ESTSAUTH
+}
+
+function sleep(ms) {
+  return new Promise(r => setTimeout(r, ms))
+}
diff --git a/app/auth/importIntoElectron.js b/app/auth/importIntoElectron.js
new file mode 100644
index 0000000..2871193
--- /dev/null
+++ b/app/auth/importIntoElectron.js
@@ -0,0 +1,39 @@
+const { session } = require("electron");
+
+exports = module.exports = async function importCookiesIntoElectron(cookies, partition) {
+  const sess = session.fromPartition(partition);
+
+  // Allow third-party cookies; AAD uses multiple domains
+  sess.setPermissionRequestHandler((_wc, _perm, cb) => cb(true));
+
+  for (const c of cookies) {
+    // Electron wants expiry in seconds, domain/path same as Chrome
+    const cookie = {
+      url: (c.secure ? "https://" : "http://") + (c.domain.startsWith(".") ? c.domain.slice(1) : c.domain) + (c.path || "/"),
+      name: c.name,
+      value: c.value,
+      domain: c.domain,
+      path: c.path || "/",
+      secure: c.secure,
+      httpOnly: c.httpOnly,
+      expirationDate: c.expires > 0 ? c.expires : undefined,
+      sameSite: mapSameSite(c.sameSite), // "Strict" | "Lax" | "None"
+    };
+
+    try {
+      await sess.cookies.set(cookie);
+    } catch (e) {
+      // Some host-only vs domain cookie quirks can throw; skip non-critical ones
+      // You can retry with adjusted domain/path if needed.
+      console.warn("Cookie set failed", c.name, e);
+    }
+  }
+}
+
+function mapSameSite(ss) {
+  if (!ss) return "lax";
+  const m = ss.toLowerCase();
+  if (m.includes("none")) return "no_restriction";
+  if (m.includes("strict")) return "strict";
+  return "lax";
+}
diff --git a/app/auth/launchChromium.js b/app/auth/launchChromium.js
new file mode 100644
index 0000000..23964fb
--- /dev/null
+++ b/app/auth/launchChromium.js
@@ -0,0 +1,66 @@
+const util = require('node:util');
+const exec = util.promisify(require('node:child_process').exec);
+const { spawn } = require("node:child_process");
+const getPort = require("get-port").default;
+const tmp = require("tmp");
+const fs = require('fs');
+
+exports = module.exports = async function launchChromium() {
+  const port = await getPort();
+  const tmpDir = tmp.dirSync({ unsafeCleanup: true }).name;
+
+  const binary = await getSuitableBinary();
+  const args = [
+    `--remote-debugging-port=${port}`,
+    `--user-data-dir=${tmpDir}`,
+    "--no-first-run",
+    "--no-default-browser-check",
+    "--disable-default-apps",
+    "--disable-features=NetworkServiceInProcess", // stability
+    "--enable-features=NetworkService,TrustTokens,StorageAccessAPI",
+    "--incognito=false",
+    "https://teams.microsoft.com",
+  ];
+
+  const proc = spawn(binary, args, { stdio: "ignore", detached: false });
+
+  return { proc, port, userDataDir: tmpDir };
+}
+
+async function getSuitableBinary() {
+  const envVariableName = "T4L_CHROMIUM_BINARY";
+  const binaryVariable = process.env[envVariableName];
+  const suitableBinaries = ["chromium", "chrome", "brave"];
+
+  if (binaryVariable) {
+    console.log(`Variable '${envVariableName}' set`);
+    if (fs.existsSync(binaryVariable)) {
+      return binaryVariable;
+    }
+    suitableBinaries.unshift(binaryVariable);
+  } else {
+    console.log(`Variable '${envVariableName}' not set`);
+  }
+
+  console.log(`Trying to find one of the following binaries in PATH: ['${suitableBinaries.join("', '")}']`);
+
+  for (const suitableBinary of suitableBinaries) {
+    if (await which(suitableBinary)) {
+      return suitableBinary;
+    }
+  }
+
+  throw new Error("No suitable chromium binary found! Consider setting '${envVariableName}'");
+}
+
+async function which(binaryName) {
+  try {
+    const { stdout } = await exec(`which ${binaryName}`);
+    console.log(`'${binaryName}' found in PATH: ${stdout.trim()}`);
+    return true;
+  }
+  catch {
+    console.log(`'${binaryName}' not found in PATH.`);
+    return false;
+  }
+}
diff --git a/app/auth/pullFromChromium.js b/app/auth/pullFromChromium.js
new file mode 100644
index 0000000..8061805
--- /dev/null
+++ b/app/auth/pullFromChromium.js
@@ -0,0 +1,30 @@
+const CDP = require("chrome-remote-interface");
+
+const COOKIE_DOMAINS = [
+  "teams.microsoft.com",
+  "login.microsoftonline.com",
+  ".login.microsoftonline.com",
+  ".msauth.net",
+  ".msftauth.net",
+  ".microsoft.com",
+];
+
+exports = module.exports = async function fetchCookies(port) {
+  const client = await CDP({ port });
+  const { Network } = client;
+
+  await Network.enable({});
+  // Fetch all cookies Chromium currently holds
+  const all = await Network.getAllCookies();
+  await client.close();
+
+  // Filter to interesting domains
+  const wantedCookies = all.cookies.filter(c => {
+    return COOKIE_DOMAINS.some(d => {
+      // match exact or suffix
+      return c.domain === d || c.domain.endsWith(d);
+    });
+  });
+
+  return wantedCookies;
+}
diff --git a/app/mainAppWindow/index.js b/app/mainAppWindow/index.js
index ce01664..f0f47f3 100644
--- a/app/mainAppWindow/index.js
+++ b/app/mainAppWindow/index.js
@@ -254,6 +254,11 @@ function onBeforeRequestHandler(details, callback) {
   if (customBackgroundRedirect) {
     callback(customBackgroundRedirect);
   }
+  else if (isFidoUrl(details.url)) {
+    console.log("Detected potential reauth redirect:", details.url);
+    handleReauth();
+    callback({ redirectURL: "https://teams-4-linux.marcovr.ch" })
+  }
   // Check if the counter was incremented
   else if (aboutBlankRequestCount < 1) {
     // Proceed normally
@@ -444,3 +449,30 @@ async function removePopupWindowMenu() {
 async function sleep(ms) {
   return await new Promise((r) => setTimeout(r, ms));
 }
+
+const authenticateWithChromium = require("../auth/authenticateWithChromium");
+
+let currentlyReauthing = false;
+async function handleReauth() {
+  if (currentlyReauthing) {
+    console.warn("Concurrent reauth attempt prevented");
+    return;
+  }
+
+  currentlyReauthing = true;
+  try {
+    await authenticateWithChromium(config.partition);
+  } finally {
+    setTimeout(() => {
+      currentlyReauthing = false;
+    }, 10_000);
+  }
+
+  console.log("Reloading teams - hopefully everything works now");
+  window.loadURL("https://teams.microsoft.com");
+}
+
+function isFidoUrl(url) {
+  return url.startsWith("https://login.microsoft.com/35aa8c5b-ac0a-4b15-9788-ff6dfa22901f/fido/")
+    || url.startsWith("https://login.microsoft.com/common/fido/");
+}
diff --git a/create_patch.sh b/create_patch.sh
new file mode 100755
index 0000000..741c48b
--- /dev/null
+++ b/create_patch.sh
@@ -0,0 +1,2 @@
+#!/usr/bin/env bash
+git format-patch -1 HEAD
diff --git a/launch_testing.sh b/launch_testing.sh
new file mode 100755
index 0000000..9cda0d0
--- /dev/null
+++ b/launch_testing.sh
@@ -0,0 +1,8 @@
+#!/usr/bin/env bash
+
+pattern="/nix/store/*-libsecret-*/lib"
+libsecret_paths=( $pattern )
+libsecret_path="${libsecret_paths[0]}"
+
+export LD_LIBRARY_PATH="$libsecret_path"
+nix-shell -p electron libsecret --run "electron ./app"
diff --git a/package-lock.json b/package-lock.json
index f59627d..0926c43 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -11,12 +11,15 @@
       "license": "GPL-3.0-or-later",
       "dependencies": {
         "@homebridge/dbus-native": "0.7.1",
+        "chrome-remote-interface": "^0.33.3",
         "electron-log": "^5.4.1",
         "electron-positioner": "^4.1.0",
         "electron-store": "8.2.0",
         "electron-window-state": "5.0.3",
+        "get-port": "^7.1.0",
         "lodash": "^4.17.21",
         "node-sound": "^0.0.8",
+        "tmp": "^0.2.5",
         "yargs": "^17.7.2"
       },
       "devDependencies": {
@@ -1876,6 +1879,25 @@
         "node": ">=10"
       }
     },
+    "node_modules/chrome-remote-interface": {
+      "version": "0.33.3",
+      "resolved": "https://registry.npmjs.org/chrome-remote-interface/-/chrome-remote-interface-0.33.3.tgz",
+      "integrity": "sha512-zNnn0prUL86Teru6UCAZ1yU1XeXljHl3gj7OrfPcarEfU62OUU4IujDPdTDW3dAWwRqN3ZMG/Chhkh2gPL/wiw==",
+      "license": "MIT",
+      "dependencies": {
+        "commander": "2.11.x",
+        "ws": "^7.2.0"
+      },
+      "bin": {
+        "chrome-remote-interface": "bin/client.js"
+      }
+    },
+    "node_modules/chrome-remote-interface/node_modules/commander": {
+      "version": "2.11.0",
+      "resolved": "https://registry.npmjs.org/commander/-/commander-2.11.0.tgz",
+      "integrity": "sha512-b0553uYA5YAEGgyYIGYROzKQ7X5RAqedkfjiZxwi0kL1g3bOaBNNZfYkzt/CL0umgD5wc9Jec2FbB98CjkMRvQ==",
+      "license": "MIT"
+    },
     "node_modules/chromium-pickle-js": {
       "version": "0.2.0",
       "resolved": "https://registry.npmjs.org/chromium-pickle-js/-/chromium-pickle-js-0.2.0.tgz",
@@ -3440,6 +3462,18 @@
         "url": "https://github.com/sponsors/ljharb"
       }
     },
+    "node_modules/get-port": {
+      "version": "7.1.0",
+      "resolved": "https://registry.npmjs.org/get-port/-/get-port-7.1.0.tgz",
+      "integrity": "sha512-QB9NKEeDg3xxVwCCwJQ9+xycaz6pBB6iQ76wiWMl1927n0Kir6alPiP+yuiICLLU4jpMe08dXfpebuQppFA2zw==",
+      "license": "MIT",
+      "engines": {
+        "node": ">=16"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/get-proto": {
       "version": "1.0.1",
       "resolved": "https://registry.npmjs.org/get-proto/-/get-proto-1.0.1.tgz",
@@ -6073,10 +6107,9 @@
       }
     },
     "node_modules/tmp": {
-      "version": "0.2.3",
-      "resolved": "https://registry.npmjs.org/tmp/-/tmp-0.2.3.tgz",
-      "integrity": "sha512-nZD7m9iCPC5g0pYmcaxogYKggSfLsdxl8of3Q/oIbqCqLLIO9IAF0GWjX1z9NZRHPiXv8Wex4yDCaZsgEw0Y8w==",
-      "dev": true,
+      "version": "0.2.5",
+      "resolved": "https://registry.npmjs.org/tmp/-/tmp-0.2.5.tgz",
+      "integrity": "sha512-voyz6MApa1rQGUxT3E+BK7/ROe8itEx7vD8/HEvt4xwXucvQ5G5oeEiHkmHZJuBO21RpOf+YYm9MOivj709jow==",
       "license": "MIT",
       "engines": {
         "node": ">=14.14"
@@ -6335,6 +6368,27 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/ws": {
+      "version": "7.5.10",
+      "resolved": "https://registry.npmjs.org/ws/-/ws-7.5.10.tgz",
+      "integrity": "sha512-+dbF1tHwZpXcbOJdVOkzLDxZP1ailvSxM6ZweXTegylPny803bFhA+vqBYw4s31NSAk4S2Qz+AKXK9a4wkdjcQ==",
+      "license": "MIT",
+      "engines": {
+        "node": ">=8.3.0"
+      },
+      "peerDependencies": {
+        "bufferutil": "^4.0.1",
+        "utf-8-validate": "^5.0.2"
+      },
+      "peerDependenciesMeta": {
+        "bufferutil": {
+          "optional": true
+        },
+        "utf-8-validate": {
+          "optional": true
+        }
+      }
+    },
     "node_modules/xml2js": {
       "version": "0.6.2",
       "resolved": "https://registry.npmjs.org/xml2js/-/xml2js-0.6.2.tgz",
diff --git a/package.json b/package.json
index 62add1b..640d103 100644
--- a/package.json
+++ b/package.json
@@ -44,12 +44,15 @@
   },
   "dependencies": {
     "@homebridge/dbus-native": "0.7.1",
+    "chrome-remote-interface": "^0.33.3",
     "electron-log": "^5.4.1",
     "electron-positioner": "^4.1.0",
     "electron-store": "8.2.0",
     "electron-window-state": "5.0.3",
+    "get-port": "^7.1.0",
     "lodash": "^4.17.21",
     "node-sound": "^0.0.8",
+    "tmp": "^0.2.5",
     "yargs": "^17.7.2"
   },
   "devDependencies": {
-- 
2.50.1

